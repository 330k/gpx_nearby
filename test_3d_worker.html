<html>
<head>
<title>GPXデータのルート沿いのコンビニを得る 地心直交座標系</title>
<script>
const myWorker = new Worker("worker.js");

window.addEventListener("DOMContentLoaded", function(){
  document.getElementById("gpx_file").addEventListener("change", openGPXFile);
  document.getElementById("course_deviation_threshold").addEventListener("change", openGPXFile);
  document.getElementById("copy_clipboard_result").addEventListener("click", function(e){
    try{
      if(navigator.clipboard){
        navigator.clipboard.writeText(document.getElementById("result").textContent);
      }
    }catch(err){
      console.error(err);
    }
    
    e.preventDefault();
    return false;
  });
});

/**
 * GPXファイルを読み込むPromiseを返す
 * @param {string} file 読み込むファイル
 * @return {XMLDocument} 読み込んだ結果をXMLObjectを返すPromise
 */
function readGPX(file){
  return new Promise(function(resolve, reject){
    try{
      const reader = new FileReader();
      const parser = new DOMParser();

      reader.onload = function(){
        resolve(parser.parseFromString(reader.result, "text/xml"));
      };
      reader.readAsText(file, "utf-8");
      
    }catch(e){
      reject(e);
    }
  });
}

async function openGPXFile(){
  try{
    //document.getElementById("loader").style.display = "block";
    if(document.getElementById("gpx_file").files.length !== 1){
      throw new Error("no files / too many files are selected");
    }
    const gpx_file = document.getElementById("gpx_file").files[0];
    const course_deviation_threshold = document.getElementById("course_deviation_threshold").value - 0;
    
    console.time("searchNearbyShops");
    console.time("readGPX");
    const gpx = await readGPX(gpx_file);
    console.timeEnd("readGPX");
    
    console.time("createCoursePoints");
    let coursepoints = createCoursePoints(gpx);
    console.timeEnd("createCoursePoints");
    console.log("course points: " + coursepoints.length);
    
    myWorker.postMessage({
      "coursepoints": coursepoints,
      "course_deviation_threshold": course_deviation_threshold
    });
    
    myWorker.onmessage = function(e){
      document.getElementById("loader").style.display = "none";
      console.timeEnd("searchNearbyShops");
      outputShopList(e.data);
    }
    
  }catch(err){
    console.error(err);
  }finally{
  }
}

/**
 * GPXデータから計算用のコースデータを作成
 * @param {XMLDocument} gpx
 * @return {[{lat:number,lon:number}]}
 */
function createCoursePoints(gpx){
  const trkpts = gpx.querySelectorAll("trkpt");
  const result = [];
  let coursedist = 0.0;
  
  for(let i = 0; i < trkpts.length; i++){
    const lat = trkpts[i].getAttribute("lat") - 0;
    const lon = trkpts[i].getAttribute("lon") - 0;
    
    result.push({
      "lat": lat,
      "lon": lon
    });
  }
  
  return result;
}

/**
 * 結果を画面に出力
 */
function outputShopList(list){
  const ele = document.getElementById('result');
  const buf = [];
  
  const gmaplink = function(lat, lon, name, text){
    return '<a href="https://www.google.co.jp/maps?q=' + lat.toFixed(6) + ',' + lon.toFixed(6) + '" target="_blank">' + text + '</a>';
  };
  const ymaplink = function(lat, lon, name, text){
    return '<a href="https://map.yahoo.co.jp/search?lat=' + lat.toFixed(6) + '&lon=' + lon.toFixed(6) + '&zoom=16&maptype=basic" target="_blank">' + text + '</a>';
  };
  
  buf.push('<table class="pure-table pure-table-bordered">');
  buf.push('<thead><tr><th>ルート距離 [km]</th><th>ルートからの距離 [m]</th><th>店舗名</th><th>データソース</th><th>カテゴリ</th><th>地図</th></tr></thead>');
  buf.push('<tbody>');
  
  for(const s of list.values()){
    buf.push('<tr>'
      + '<td align="right">' + (s.coursedist * 0.001).toFixed(1) + '</td>'
      + '<td align="right">' + s.pointdist.toFixed(0) + '</td>'
      + '<td align="left" title="' + JSON.stringify(s).replace(/"/g, "'") + '">' + s.name + '</td>'
      + '<td align="left">' + s.source + '</td>'
      + '<td align="left">' + s.category + '</td>'
//      + '<td align="right">' + s.lat.toFixed(6) + ' ' + s.lon.toFixed(6) + '</td>'
      + '<td align="left">' + gmaplink(s.lat, s.lon, s.name, '地図') + '</td>'
      + '</tr>'
    );
  }
  
  buf.push('</tbody></table>');
  
  ele.innerHTML = buf.join('\n');
}
</script>
<!--<link rel="stylesheet" href="https://unpkg.com/purecss@2.0.6/build/pure-min.css" integrity="sha384-Uu6IeWbM+gzNVXJcM9XV3SohHtmWE+3VGi496jvgX1jyvDTXfdK+rfZc8C1Aehk5" crossorigin="anonymous">-->
<style>
table { border-collapse: collapse; }
th, td { border: 1px solid gray; }
* { margin: 0; padding: 0}
body { padding: 1em; }
#loader { display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); }

/*#header { position: fixed; width: 100%; height: 60px; top: 0; background: white; border-bottom: 1px solid gray; z-index: 99999; }
#result { position: absolute; margin-top: 60px; }
#result table { width: 100%; }*/

</style>
</head>
<body>
<div id="header">
<h1>ルート沿い施設検索</h1>
<form class="pure-form pure-form-stacked">
<div class="pure-g">
 <div class="pure-u-1-5 pure-u-md-1-5">
  <legend>GPXファイル</legend>
  <input type="file" id="gpx_file" accept=".gpx" />
 </div>
 <div class="pure-u-1-5 pure-u-md-1-5">
  <legend>ルートからの距離</legend>
  <select id="course_deviation_threshold">
  <option value="100">&lt;100 m</option>
  <option value="200">&lt;200 m</option>
  <option value="300">&lt;300 m</option>
  </select>
 </div>
 <div class="pure-u-1-5 pure-u-md-1-5">
  <legend>検索対象</legend>
  <label class="pure-checkbox"><input type="checkbox" name="search_target" value="コンビニエンスストア" checked />コンビニエンスストア</label>
  <label class="pure-checkbox"><input type="checkbox" name="search_target" value="道の駅" checked />道の駅</label>
  <!--<label class="pure-checkbox"><input type="checkbox" name="search_target" value="ホテル" checked />ホテル</label>-->
 </div>
 <div class="pure-u-1-5 pure-u-md-1-5">
  <button id="copy_clipboard_result" class="pure-button pure-button-primary pure-button-disabled">結果をクリップボードにコピー</button>
 </div>
</div>
</form>
</div>
<div id="result"></div>
<div id="loader"><img src="data:image/svg+xml,%3Csvg width='32' height='32' xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100' preserveAspectRatio='xMidYMid' class='uil-spin'%3E%3Cpath fill='none' class='bk' d='M0 0h100v100H0z'/%3E%3Cg transform='translate(84 50)'%3E%3Ccircle r='8'%3E%3Canimate attributeName='opacity' from='1' to='.1' begin='0s' dur='1s' repeatCount='indefinite'/%3E%3CanimateTransform attributeName='transform' type='scale' from='1.5' to='1' begin='0s' dur='1s' repeatCount='indefinite'/%3E%3C/circle%3E%3C/g%3E%3Cg transform='rotate(45 -52.355 126.397)'%3E%3Ccircle r='8'%3E%3Canimate attributeName='opacity' from='1' to='.1' begin='0.12s' dur='1s' repeatCount='indefinite'/%3E%3CanimateTransform attributeName='transform' type='scale' from='1.5' to='1' begin='0.12s' dur='1s' repeatCount='indefinite'/%3E%3C/circle%3E%3C/g%3E%3Cg transform='rotate(90 -17 67)'%3E%3Ccircle r='8'%3E%3Canimate attributeName='opacity' from='1' to='.1' begin='0.25s' dur='1s' repeatCount='indefinite'/%3E%3CanimateTransform attributeName='transform' type='scale' from='1.5' to='1' begin='0.25s' dur='1s' repeatCount='indefinite'/%3E%3C/circle%3E%3C/g%3E%3Cg transform='rotate(135 -2.355 42.397)'%3E%3Ccircle r='8'%3E%3Canimate attributeName='opacity' from='1' to='.1' begin='0.37s' dur='1s' repeatCount='indefinite'/%3E%3CanimateTransform attributeName='transform' type='scale' from='1.5' to='1' begin='0.37s' dur='1s' repeatCount='indefinite'/%3E%3C/circle%3E%3C/g%3E%3Cg transform='rotate(180 8 25)'%3E%3Ccircle r='8'%3E%3Canimate attributeName='opacity' from='1' to='.1' begin='0.5s' dur='1s' repeatCount='indefinite'/%3E%3CanimateTransform attributeName='transform' type='scale' from='1.5' to='1' begin='0.5s' dur='1s' repeatCount='indefinite'/%3E%3C/circle%3E%3C/g%3E%3Cg transform='rotate(-135 18.355 7.603)'%3E%3Ccircle r='8'%3E%3Canimate attributeName='opacity' from='1' to='.1' begin='0.62s' dur='1s' repeatCount='indefinite'/%3E%3CanimateTransform attributeName='transform' type='scale' from='1.5' to='1' begin='0.62s' dur='1s' repeatCount='indefinite'/%3E%3C/circle%3E%3C/g%3E%3Cg transform='rotate(-90 33 -17)'%3E%3Ccircle r='8'%3E%3Canimate attributeName='opacity' from='1' to='.1' begin='0.75s' dur='1s' repeatCount='indefinite'/%3E%3CanimateTransform attributeName='transform' type='scale' from='1.5' to='1' begin='0.75s' dur='1s' repeatCount='indefinite'/%3E%3C/circle%3E%3C/g%3E%3Cg transform='rotate(-45 68.355 -76.397)'%3E%3Ccircle r='8'%3E%3Canimate attributeName='opacity' from='1' to='.1' begin='0.87s' dur='1s' repeatCount='indefinite'/%3E%3CanimateTransform attributeName='transform' type='scale' from='1.5' to='1' begin='0.87s' dur='1s' repeatCount='indefinite'/%3E%3C/circle%3E%3C/g%3E%3C/svg%3E" width="128" height="128"></div>
</body>
